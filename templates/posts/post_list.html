{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load profile_tags %}
{% load post_filters %}
{% load time_filters %}

{% block body_class %}platform-page post-list-page{% endblock body_class %}
{% block title %}Home - TradesApp{% endblock %}

{% block extra_head %}
<!-- Add platform-specific CSS -->
<link rel="stylesheet" href="{% static 'glocalization_app/css/02-platform-layout.css' %}">
<link rel="stylesheet" href="{% static 'glocalization_app/css/post-detail/post-detail.css' %}">
{% endblock %}

{% block site-header-content %}
<div class="feed-nav header">
    <span class="feed-nav-icon-container">
        <!-- Active page indicator for Home/Feed -->
        <a href="/" class="nav-link nav-link--active" title="Feed" data-page="feed">
            <span class="nav-link__icon">
                {% include 'icons/home.html' %}
            </span>
            <span class="nav-link__label">Ads</span>
            <span class="nav-link__indicator"></span>
        </a>
        
        <a href="{% url 'seekers:seeker_list' %}" class="nav-link" title="Seekers" data-page="seekers">
            <span class="nav-link__icon">
                {% include 'icons/icon-seeker.html' %}
            </span>
            <span class="nav-link__label">Want</span>
            <span class="nav-link__indicator"></span>
        </a>
    </span>
    
    <!-- Optional search icon on the right -->
</div>
{% endblock site-header-content %}

{% block content %}
    
    <!-- CENTER FEED -->
    <main class="platform-feed">        
        <!-- Filter Path (if searching) -->
        {% if search_path %}
        <div class="px-3 py-2 bg-light border-bottom">
            <small class="text-muted">
                <i class="fas fa-filter"></i> Filtered by: {{ search_path|join:" → " }}
            </small>
        </div>
        {% endif %}
        
        <!-- Feed Content -->
        <div class="feed-content  container-fluid" id="postContainer">
            
            {% for post in posts %}
            <!-- Feed Card (X/Twitter Style) -->
                <article class="feed-card feed-card--detail" 
                    data-scope="{{ post.availability_scope }}"
                    data-town="{{ post.post_town.name|default:post.post_town_input|lower }}"
                    data-post-id="{{ post.pk }}">
                    
                    <div class="feed-card-header">
                        <a href="{% url 'person_detail' post.author.pk %}">
                            {% profile_picture post.author size=48 css_class="feed-card-avatar" %}                        
                        </a>
                    
                        <div class="feed-card-meta" onclick="window.location=`{% url 'post_detail' post.pk %}`">
                            <div class="feed-card-author">
                                <span class="feed-card-name">
                                    {{ post.author.profile.business_name }}
                                </span>
                                <span class="feed-card-time"> • {{ post.date|short_time }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="feed-card-body">
                        <div class="feed-card-text" onclick="window.location=`{% url 'post_detail' post.pk %}`">
                            {{ post.description|urlize|linebreaksbr }}
                        </div>
                        
                        <div class="text-muted feed-card-location" onclick="window.location=`{% url 'post_detail' post.pk %}`">
                                {% if post.post_town %}{{ post.post_town.name }}
                                {% elif post.post_town_input %}{{ post.post_town_input }}
                                {% endif %}
                                {% if post.post_state %}, {{ post.post_state.name }}{% endif %},
                                {% if post.post_country %}{{ post.post_country.name }}{% endif %},
                                {% if post.post_continent %}{{ post.post_continent.name }}{% endif %}.
                        </div>
                        
                        <!-- Enhanced Media Carousel -->
                        {% include 'media_app/media_carousel.html' with media_files=post.media_files.all object_id=post.pk %}

                        <a href="tel:{{ post.author_phone_number }}">
                            <span class="feed-action" >
                                <i class="fa-solid fa-phone"></i>
                            </span>
                        </a>
                    </div>
                </article>
            {% empty %}
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3>No posts yet</h3>
                <p>Be the first to share something with your community!</p>
                {% if user.is_authenticated %}
                <a href="{% url 'post_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Create Your First Post
                </a>
                {% endif %}
            </div>
            {% endfor %}
            <div class="jump-to-top-container">                
                <center>
                    <a href="{% url 'post_home' %}">
                        <span class="jump-to-top" onclick="location.reload();">
                            <i class="fa-solid fa-arrow-up"></i>
                            <p>Load new</p>
                            <a href="{% url 'post_create' %}">
                                <div class="floating-cta-button">
                                    <a href="{% url 'post_create' %}" class="floating-cta-button-child" aria-label="Post ad">
                                        {% include "icons/icon-create.html" %}
                                        <!-- <i class="fa-solid fa-plus"></i> -->
                                        <!-- <span>Post</span> -->
                                    </a>
                                </div>                                
                            </a>
                        </span>
                    </a>
                </center>
            </div>
        </div>
    </main>

{# ---------- Fullscreen image viewer ---------- #}
<div class="post-fullscreen-overlay" id="postImageOverlay" aria-hidden="true">
    <div class="post-fullscreen-inner">

        <div class="post-fullscreen-top">

            <div class="post-fullscreen-top-actions">
                {% if post.author_phone_number %}
                <a href="tel:{{ post.author_phone_number }}" class="post-fullscreen-cta">
                    <i class="fa-solid fa-phone"></i>
                </a>
                {% endif %}
                <button class="post-fullscreen-close" aria-label="Close fullscreen">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>

        <button class="post-fullscreen-nav post-fullscreen-nav--prev" aria-label="Previous image">
            <i class="fa-solid fa-chevron-left"></i>
        </button>

        <img src="" alt="" class="post-fullscreen-image">
        {# Video for videos #}
        <video class="post-fullscreen-video" controls>
            <source src="" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <button class="post-fullscreen-nav post-fullscreen-nav--next" aria-label="Next image">
            <i class="fa-solid fa-chevron-right"></i>
        </button>

        <div class="post-fullscreen-counter" id="postFullscreenCounter">
            1 / 1
        </div>
    </div>
</div>

<!-- User's town for JS filtering -->
<script>
    const currentUserTown = "{{ user.profile.town.name|lower }}";
</script>


<!-- Your existing JS files (unchanged) -->
{% include "posts/includes/js_imports.html" %}

{% endblock %}
{% block bottom_navigation %}
        <nav class="bottom-nav" aria-label="Mobile navigation">
            <a href="/" class="bottom-nav-item nav-link--active" aria-label="Home">
                <!-- <i class="fa-solid fa-house"></i> -->
                {% include 'icons/icon-home-bottom-nav.html'%}
                <span class="bottom-nav-link__label">Ads</span>
                <span class="bottom-nav-link__indicator"></span>
                <!-- <span>Home</span> -->
            </a>
            <a href="{% url 'postfinder_search' %}" class="bottom-nav-item" aria-label="Search">
                <!-- <i class="fa-solid fa-magnifying-glass"></i> -->
                {% include 'icons/magnifier_bottom_svg.html' %}
                <span class="bottom-nav-link__label">Search</span>
                <!-- <span class="bottom-nav-link__indicator"></span> -->
                <!-- <span>Search</span> -->
            </a>
            <a href="{% url 'seekers:seeker_list' %}" class="bottom-nav-item" aria-label="Home">
                <!-- <i class="fa-solid fa-house"></i> -->
                {% include 'icons/icon-seeker-bottom-nav.html'%}
                <span class="bottom-nav-link__label">Want</span>
                <!-- <span class="bottom-nav-link__indicator"></span> -->
                <!-- <span>Home</span> -->
            </a>
            <a href="{% url 'post_create' %}" class="bottom-nav-item bottom-nav-cta" aria-label="Post ad">
                {% include 'icons/icon-create.html' %}
                <!-- <span>Post</span> -->
            </a>
        </nav>
{% endblock bottom_navigation %}