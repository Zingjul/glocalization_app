{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Seekers - TradesApp{% endblock %}

{% block extra_head %}
<!-- Add platform-specific CSS - same as post_list -->
<link rel="stylesheet" href="{% static 'glocalization_app/css/02-platform-layout.css' %}">
{% endblock %}

{% block site-header-content %}
    <a href="/" class="nav-link" title="feed">
        {% include 'icons/home.html' %}
    </a>
{% endblock site-header-content %}
{% block content %}
<body class="platform-page">

<div class="platform-wrapper" id="platformWrapper">
    <!-- LEFT SIDEBAR (same as post_list) -->
    <aside class="platform-sidebar" id="platformSidebar">
        <div class="function-key-toggle-notification" id="hideSideBar" title="Toggle Notifications Sidebar Hide">
            <span>
                x
            </span>
        </div>
        <!-- User Info (if authenticated) -->
        {% if user.is_authenticated %}
        <div class="sidebar-header">
            <a href="{% url 'person_detail' user.pk %}">
            <div class="sidebar-user-info">
                <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=667eea&color=fff" 
                     alt="{{ user.username }}" 
                     class="sidebar-avatar">
                <div class="sidebar-user-details">
                    {% if user.profile %}
                        <h5>You</h5>
                        <p>{{ user.email }}</p>
                    {% else %}
                    
                    {% endif %}
                </div>
            </div>
            </a>
        </div>
        {% endif %}
        
        <!-- Navigation -->
        <nav class="sidebar-nav">            
            {% if user.is_authenticated %}
            <!-- Highlight Seekers as active since we're on this page -->         
            <a href="{% url 'notifications:notifications-page' %}" class="sidebar-nav-item" data-tooltip="Notifications">
                <i class="fas fa-bell"></i>
                <span>Notifications</span>
            </a>
            
            <a href="{% url 'person_list' %}" class="sidebar-nav-item" data-tooltip="Community">
                <i class="fas fa-users"></i>
                <span>Community</span>
            </a>
            
            <!-- New item for Seekers - mark as active -->
            <a href="{% url 'seekers:seeker_list' %}" class="sidebar-nav-item active" data-tooltip="Seekers">
                <i class="fas fa-search"></i>
                <span>Seeker Requests</span>
            </a>
            
            <a href="{% url 'seekers:my_pending_seekers' %}" class="sidebar-nav-item" data-tooltip="My Seekers">
                <i class="fas fa-clock"></i>
                <span>My Seekers</span>
            </a>
            
            <a href="{% url 'post_home' %}" class="sidebar-nav-item" data-tooltip="Marketplace">
                <i class="fas fa-store"></i>
                <span>Marketplace</span>
            </a>
            
            <a href="{% url 'subscription:plans' %}" class="sidebar-nav-item" data-tooltip="Premium">
                <i class="fas fa-crown"></i>
                <span>Premium</span>
            </a>
            {% else %}
            <a href="{% url 'login' %}" class="sidebar-nav-item">
                <i class="fas fa-sign-in-alt"></i>
                <span>Login</span>
            </a>
            
            <a href="{% url 'signup' %}" class="sidebar-nav-item">
                <i class="fas fa-user-plus"></i>
                <span>Sign Up</span>
            </a>
            {% endif %}
        </nav>
    </aside>
    
    <!-- CENTER FEED -->
    <main class="platform-feed">
        <!-- Search Bar Section (updated to match post_list) -->
        <div class="feed-search header">
            <form method="get" action="{% url 'seekersfinder:seekerfinder' %}" class="search-form">
                <input type="text" 
                    name="q" 
                    class="form-control"
                    placeholder="Search seeker requests..."
                    value="{{ request.GET.q|default:'' }}">
                
                <button type="submit" class="search-button">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </form>
        </div>
        
        <!-- Filter Path (if searching) -->
        {% if search_path %}
        <div class="px-3 py-2 bg-light border-bottom">
            <small class="text-muted">
                <i class="fas fa-filter"></i> Filtered by: {{ search_path|join:" â†’ " }}
            </small>
        </div>
        {% endif %}
        
        <!-- Feed Content -->
        <div class="feed-content" id="seekerContainer">
            {% for post in posts %}
            <!-- Seeker Card (Twitter/X Style - matching post_list format) -->
            <article class="feed-card" 
                     data-scope="{{ post.availability_scope }}"
                     data-town="{{ post.seeker_town.name }}"
                     onclick="window.location=`{% url 'seekers:seeker_detail' post.pk %}`">
                
                <div class="feed-card-header">
                    <img src="https://ui-avatars.com/api/?name={{ post.author.username }}&background=667eea&color=fff" 
                         alt="{{ post.author.username }}" 
                         class="feed-card-avatar">
                    
                    <div class="feed-card-meta">
                        <div class="feed-card-author">
                            <span class="feed-card-name">
                                {% if post.author.profile %}
                                    {{ post.author.profile.business_name|default:post.author.username }}
                                {% else %}
                                    {{ post.author.username }}
                                {% endif %}
                            </span>
                            <span class="feed-card-time">{{ post.date|naturaltime }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="feed-card-body">
                    <!-- Seeker Title (what they're looking for) -->
                    <div class="feed-card-title">
                        {{ post.seeker_product_name }}
                    </div>
                    
                    <!-- Description -->
                    <div class="feed-card-text">{{ post.description }}</div>
                    
                    <!-- Budget if available -->
                    {% if post.budget %}
                    <div class="mb-2">
                        <span class="text-primary fs-5 fw-bold">
                            Budget: ${{ post.budget|floatformat:2|intcomma }}
                        </span>
                    </div>
                    {% endif %}
                    
                    <!-- Location -->
                    <div class="text-muted">
                        <i class="fas fa-map-marker-alt"></i>
                        {% if post.seeker_town %}
                            {{ post.seeker_town.name }}
                        {% elif post.seeker_town_input %}
                            {{ post.seeker_town_input }}
                        {% endif %}
                        {% if post.seeker_state %}
                            , {{ post.seeker_state.name }}
                        {% elif post.seeker_state_input %}
                            , {{ post.seeker_state_input }}
                        {% endif %}
                    </div>
                    
                    <!-- Urgency indicator if needed soon -->
                    {% if post.needed_by %}
                    <div class="mt-2">
                        <span class="text-warning">
                            <i class="fas fa-clock"></i> Needed by: {{ post.needed_by|date:"M d, Y" }}
                        </span>
                    </div>
                    {% endif %}
                </div>
            </article>
            {% empty %}
            <!-- Empty state matching post_list style -->
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h3>No seeker requests yet</h3>
                <p>Be the first to post what you're looking for!</p>
                {% if user.is_authenticated %}
                <a href="{% url 'seekers:seeker_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Post Seeker Request
                </a>
                {% endif %}
            </div>
            {% endfor %}
            
            <!-- Floating CTA Button (for creating seeker request) -->
            <div class="floating-cta-button">
                <a href="{% url 'seekers:seeker_create' %}" class="floating-cta-button-child" aria-label="Post seeker request">
                    <i class="fa-solid fa-search"></i>
                </a>
            </div>
            
            <!-- Jump to top (load new seekers) -->
            <div class="jump-to-top-container">
                <center>
                    <a href="{% url 'seekers:seeker_list' %}">
                        <span class="jump-to-top" onclick="location.reload();">
                            <i class="fa-solid fa-arrow-up"></i>
                            <p>Load new</p>
                        </span>
                    </a>
                </center>
            </div>
        </div>
    </main>
    
    <!-- RIGHT WIDGETS -->
    <aside class="platform-widgets">
        <!-- Trending Seeker Categories -->
        <a href="{% url 'board:unified_board' %}">
            <div class="widget-card">
                <h4 class="widget-title">Popular Requests <i class="fas fa-fire"></i></h4>
                <div class="widget-item">
                    <span>Electronics</span>
                    <span class="text-muted">12 seekers</span>
                </div> 
                <div class="widget-item">
                    <span>Services</span>
                    <span class="text-muted">8 seekers</span>
                </div>
                <div class="widget-item">
                    <span>Housing</span>
                    <span class="text-muted">5 seekers</span>
                </div>
                <div class="widget-item">
                    <span>Vehicles</span>
                    <span class="text-muted">3 seekers</span>
                </div>
            </div>
        </a>
        
        <!-- Seeker Stats (if authenticated) -->
        {% if user.is_authenticated %}
        <div class="widget-card">
            <h4 class="widget-title">Your Seeker Activity</h4>
            <div class="widget-item">
                <span>Active Requests</span>
                <span class="fw-bold">{{ user_active_seekers|default:"0" }}</span>
            </div>
            <div class="widget-item">
                <span>Responses Received</span>
                <span class="fw-bold">{{ user_responses|default:"0" }}</span>
            </div>
            <div class="widget-item">
                <span>Requests Fulfilled</span>
                <span class="fw-bold">{{ user_fulfilled|default:"0" }}</span>
            </div>
        </div>
        {% endif %}
        
        <!-- Quick Tips -->
        <div class="widget-card">
            <h4 class="widget-title">Seeker Tips ðŸ’¡</h4>
            <ul class="small text-muted" style="padding-left: 15px;">
                <li>Be specific about what you need</li>
                <li>Include your budget range</li>
                <li>Mention when you need it by</li>
                <li>Respond promptly to offers</li>
            </ul>
        </div>
        
        <!-- Footer -->
        <div class="text-muted small mt-4">
            <a href="#" class="text-muted me-2">About</a>
            <a href="#" class="text-muted me-2">Terms</a>
            <a href="#" class="text-muted me-2">Privacy</a>
            <a href="#" class="text-muted">Help</a>
            <div class="mt-2">Â© 2025 TradesApp</div>
        </div>
    </aside>
</div>

<!-- User's town for JS filtering (same as post_list) -->
<script>
    const currentUserTown = "{{ user.profile.town.name|lower }}";
</script>

<!-- Seeker-specific JS files -->
<script src="{% static 'js/seekers_render_onload.js' %}"></script>
<script src="{% static 'js/seekers_scope_filter.js' %}"></script>
{% endblock %}